# Тестовое задание

## Легенда

В команду тестирования пришла задача: необходимо протестировать оплату зарубежных сервисов.
Запрос на оплату формируется пользователем на frontend и содержит наименование провайдера, сумму и дату.   
Cумма вводится в валюте получателя платежа, а итоговая сумма рассчитывается в рублях в зависимости от курса ЦБ.
Известно, что на текущий момент, нашей платёжной системе, запрещено выполнять платёж на сумму более 15000р.

## Суть задания

Необходимо реализовать мок-сервис имитирующий ответ от https://www.cbr.ru/scripts/XML_daily.asp?date_req=02/03/2002 и
обеспечивающий гибкость, воспроизводимость и надёжность тестов.

Подсказка: начать стоит с написания тесткейсов.

## Особенности

- Микросервисная архитектура и асинхронное взаимодействие не допускают возможность пробрасывать какие либо параметры
  или заголовки для управления моком.
- Единый тестовый стенд с сотнями параллельно запускаемыми end-to-end тестами.

## Будет плюсом:

- makefile/taskfile с командой для запуска
- наличие proto
- наличие swagger
- golang
- использование БД

## Тесткейсы

Давайте подумаем со стороны фичи с оплатой зарубежных сервисов, она будет контактировать с моком и что она хочет
видеть ?  
Какое поведение будет максимально отражать реальную систему ?

- Обычная работа сервиса (отвечает на запросы с миниимальной задержкой)
- Работа с дилэем (когда на сервис есть большая нагрузки и отвечает с задержкой)
- Сервис упал (получаем только 500)
- Сервис отвечает пустым списком(как позже мы поймем - сервис дает всегда полный список котировок валют,
  если дата актуальная. Но может быть момент,
  что мы хотим увидеть некую валюту N в этом списке, но её там нет, что делать ?)  
  <br/><br/>
  Теперь давайте с помощью тесткейсов изучим внешнюю интеграцию:  
  Принимает 1 параметр date_req и возвращает некий xml  
  Для описания тесткейсов воспользуемся такими техниками тест-дизайна, как - классы эквивалентности и граничные
  значения:
- Нам нужна текущая дата (отсутствие передаваемого параметра date_req)
- Дата чуть меньше текущей
- Дата чуть позже текущей (ближайшая дата для наступления)
- Дата очень ранняя (Например получение котировки за 1930 год)
- Дата очень поздняя (Например получение котировок за 2040 год)
  <br/><br/>
- Один негативный тесткейс на получение данных при передачи даты в неверном формате или в целом странной строки в
  date_req   
  <br/><br/>

|                                   Описание                                   |        Результат        | Комментарий о реализации в моке                                                                                                               |  
|:----------------------------------------------------------------------------:|:-----------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------|  
| Отправка запроса на получение данных, без передачи параметра даты в date_req | Получаем корректный xml | Поле Date в шапке xml может отличаться от даты которую передали на 1-2 дня, так как новый курс поступает на следующий день в 14:00 по мск (1) |
|              Отправка даты меньше текущей (например на неделю)               | Получаем корректный xml | Поле Date так же может отличатся от переданного, если переданная дата является выходным днем                                                  |
|            Отправка даты чуть больше текущей(например на неделю)             | Получаем корректный xml | Поле Date имеет дату отличающуюся от переданной, скорее всего там будет актуальная дата                                                       |
|               Отправка очень ранней даты(например 01/01/1930)                | Получаем xml с ошибкой  | В xml отсутствует поля Date и name, вместо списка курсов - Error in parameters    (2)                                                         |
|               Отправка очень поздней даты(Например 01/01/2040)               | Получаем корректный xml | Будет отсутствовать список котировок, а переданная дата изменена по особой логике (3)                                                         |
|      Отправка не корректных данных в поле date_req(Например 2024-12-12)      | Получаем xml с ошибкой  | В xml отсутствует поля Date и name, вместо списка курсов - Error in parameters                                                                |

<br/><br/>
Опишем логику:

1) Для нашего мока мы не будем отталкиваться от магической информации, что в 14:00 по мск мы должны вернуть новый курс,
   до этого старый, или какая-то логика с выходными и показа курса за последний рабочий день,
   мы переложим эту ответственность на бд, если в бд есть информация на переданную дату - отдаем её, иначе ищем
   ближайшую раньше (с определенным интервалом)
2) Если самая ранняя дата в бд больше переданной -> отправляем ошибку
3) На самом деле на изучение данной логике потребовалось чуть больше запросов, но:
   Берется текущая дата и сколько дней в месяце этой даты, если в интервале от (переданная дата - количество дней в
   переданном месяце)
   до текущая дата, есть котировка в бд - она отдается + меняется дата на дату из бд, иначе отдается пустой xml в поле
   Date которого стоит (переданная дата - количество дней в переданном месяце)

## RPS - поговорим о важном

Тестировал на m1 pro
wrk -t4 -c50 -d30s -s scripts/stressTest.lua http://localhost:8080/scripts/XML_daily.asp
Running 30s test @ http://localhost:8080/scripts/XML_daily.asp
4 threads and 50 connections

| Thread Stats |  Avg   | Stdev  |   Max   | +/- Stdev |
|:------------:|:------:|:------:|:-------:|:---------:|
|   Latency    | 6.46ms | 1.08ms | 48.78ms |  96.53%   |
|   Req/Sec    | 1.87k  | 115.81 |  2.04k  |  66.75%   |

223732 requests in 30.01s, 55.69MB read  
Requests/sec:   7454.55  
Transfer/sec:      1.86MB  

